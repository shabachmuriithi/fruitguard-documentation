<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>FruitGuard Technical Documentation</title>
    <link
      href="https://fonts.googleapis.com/css?family=Nunito&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="style.css" />
    <script src="script.js"></script>
  </head>

  <body>
    <nav class="sidebar" aria-label="Main Documentation Navigation">
      <img src="images/fruitguardlogo.png" alt="logo" id="fruitguardlogo" />
      <h2 style="color: #ffc661">FruitGuard Documentation</h2>

      <a href="#overview" class="active">Overview</a>
      <a href="#gettingstarted">Getting Started</a>
      <a href="#systemflow">System Flow</a>
      <a href="#architecture">Architecture</a>
      <a href="#database">Database</a>
      <a href="#hardware">Hardware</a>
      <a href="#software">Software</a>
      <a href="#communication">Communication</a>
      <a href="#deployment">Deployment</a>
      <a href="#usage">Usage</a>
      <a href="#maintenance">Maintenance</a>
      <a href="#security">Security</a>
      <a href="#testing">Testing & Monitoring</a>
      <a href="#future">Future</a>
      <a href="#api">API</a>
      <a href="#best-practices">Best Practices & Standards</a>
      <a href="#deployment-ci-cd">Deployment & CI/CD</a>
    </nav>

    <main role="main" class="main">
      <div class="search-container">
        <input
          type="text"
          id="searchBar"
          placeholder="Search documentation..."
          aria-label="Search documentation"
        />
      </div>
      <section id="overview" tabindex="-1">
        <h1 id="heading">FruitGuard Technical Documentation</h1>
        <h2>1. Overview</h2>
        <p>
          FruitGuard is an IoT-enabled device that targets pervasive crop loss
          caused by fruit fly infestations across smallholder farms, providing
          cost-effective and real-time trap monitoring. Farmers receive timely
          control alerts via SMS, empowering data-driven crop protection
          decisions.
        </p>
        <p>
          This system improves monitoring efficiency, eliminates manual trap
          inspections, and enables agricultural stakeholders to optimize pest
          management practices for sustainable productivity.
        </p>

        <h3>Key features:</h3>
        <ul>
          <li>
            Real-time remote monitoring of trap fill levels.- The devices
            monitors real time fruit fly activity in the orchards.
          </li>
          <li>
            Automatic SMS alerts for maintenance triggers. - Farmers receive
            timely alerts when the trap fill level reach set theshold preventing
            re-infestation.
          </li>
        </ul>
        <h3>Benefits:</h3>
        <ul>
          <li>Real-time remote monitoring of trap fill levels.</li>
          <li>Automatic SMS alerts for maintenance triggers.</li>
          <li>Cloud-hosted data accessibility via web dashboard.</li>
          <li>Robust, low-power embedded IoT hardware.</li>
          <li>Secure and scalable backend infrastructure.</li>
        </ul>
      </section>

      <section id="gettingstarted" tabindex="-1">
        <h2>2. Getting Started</h2>
        <h3>Prerequisites</h3>
        <ul>
          <li>
            Hardware: ESP32 Microcontroller,Ultrasonic Sensor (HC-SR04), solar
            panel(power supply), LoRa Module.
          </li>
          <li>
            Software: Next js (Frontend dev), python 3.10+(Backend), PostgreSQL
            13+.
          </li>
          <li>
            Network: Stable WiFi or 4G internet for IoT data transmission.
          </li>
          <li>Deployment: Heroku and Vercel</li>
        </ul>
        <h3>Backend</h3>
        <ul>
          <li>
            Clone repository:
            <pre><code>git clone git@github.com:akirachix/fruitguard-backend.git</code></pre>
          </li>
          <li>
            Install dependencies:
            <pre><code>uv pip install djangorestframework</code></pre>
          </li>
          <li>
            Run migrations:
            <pre><code>python3 manage.py makemigrations</code></pre>
          </li>
          <li>
            Run server:
            <pre><code>python3 manage.py runserver</code></pre>
          </li>
        </ul>
        <h3>Frontend</h3>
        <ul>
          <li>
            Clone repository:
            <pre><code>git clone git@github.com:akirachix/fruitguard-frontend.git</code></pre>
          </li>
          <li>
            Install dependencies:
            <pre><code>npm install</code></pre>
          </li>
          <li>
            Run server:
            <pre><code>npm run dev</code></pre>
          </li>
        </ul>
      </section>

      <section id="systemflow" tabindex="-1">
        <h2>3. System Flow</h2>
        <h3>User Flow</h3>
        <p>
          <a
            href="https://www.figma.com/design/uFMJOjPcNqaqnj4EJQc5qR/FruitGuard?node-id=0-1&p=f&t=rCACZSeMnnmwy9Xb-0"
            >View User Flow
          </a>
        </p>

        <div style="display: flex; justify-content: space-between">
          <p>Agrovet Userflow</p>
          <p>IoT Userflow</p>
        </div>
        <div style="display: flex; gap: 20px">
          <img
            src="images/agro.png"
            alt="FruitGuard Agrovet userflow"
            style="
              max-width: 50%;
              height: auto;
              margin-top: 1rem;
              border: 1px solid #ccc;
              border-radius: 8px;
            "
          />
          <img
            src="images/io.png"
            alt="FruitGuard Agrovet userflow"
            style="
              max-width: 50%;
              height: auto;
              margin-top: 1rem;
              border: 1px solid #ccc;
              border-radius: 8px;
            "
          />
        </div>
      </section>

      <section id="architecture" tabindex="-1">
        <h2>4. System Architecture</h2>
        <p>
          The FruitGuard system is designed across five tightly integrated
          layers:
        </p>
        <ol>
          <li>
            <strong>Hardware:</strong> IoT sensors (ultrasonic) connected to
            ESP32 microcontrollers capture environmental data.
          </li>
          <li>
            <strong>Communication:</strong> Encrypted MQTT protocol transports
            telemetry securely to cloud broker.
          </li>
          <li>
            <strong>Backend:</strong> Django REST services ingest, process,
            validate, and store telemetry data with alerting capabilities.
          </li>
          <li>
            <strong>Alerting:</strong> Asynchronous SMS notifications trigger
            via SMS Leopard API upon threshold breach.
          </li>
          <li>
            <strong>Frontend:</strong> React-based dashboard for real-time
            visualization and control.
          </li>
        </ol>
        <p>
          This modular architecture enables fault isolation, scalability, and
          straightforward extensibility.
        </p>
        <a
          href="https://lucid.app/lucidchart/aa4f1515-198c-4d90-b7b4-5d384acc20c2/edit?page=0_0&invitationId=inv_19fda0ce-0ccd-4b5f-b937-4ea1e534f2f8#"
          >View System Architecture Diagram</a
        >
        <img
          src="images/system.png"
          alt="FruitGuard System Architecture Diagram"
          style="
            max-width: 100%;
            height: auto;
            margin-top: 1rem;
            border: 1px solid #ccc;
            border-radius: 8px;
          "
        />
      </section>

      <section id="database" tabindex="-1">
        <h2>5. Database</h2>
        <h3>Type</h3>
        <p>PostgreSQL</p>
        <h3>Schema</h3>
        <ul>
          <li>Users: Holds the users(farmers, Agrovet,Admin) details</li>
          <li>
            Data Monitoring: The data being sent from the sensor (distance)
          </li>
          <li>Device: Description of device properties</li>
        </ul>
        <h3>Entity Relationship Diagram</h3>
        <p>
          <a
            href="https://docs.google.com/document/d/1lqaVMvlT4UbbD9QULi7UXE3ioAt2oTj6A8wbdLpSnqE/edit?tab=t.0#heading=h.cskpbh9xtdex"
            >View Entity Relationship Diagram</a
          >
        </p>
        <img
          src="images/erd.png"
          alt="FruitGuard System Architecture Diagram"
          style="
            max-width: 100%;
            height: auto;
            margin-top: 1rem;
            border: 1px solid #ccc;
            border-radius: 8px;
          "
        />
      </section>

      <section id="hardware" tabindex="-1">
        <h2>6. Hardware details</h2>
        <p>Each FruitGuard device consists of:</p>
        <h3>Hardware Components</h3>
        <ul>
          <li>
             <strong>ESP32 MCU:</strong> </li>
             <p> Dual-core MCU, featuring integrated Wi-Fi and Bluetooth capabilities. It serves as the central processing unit for the FruitGuard device.<br>
                 Handles data acquisition from sensors, processes measurements, and manages communication with external systems</p>
          <li>
            <strong>Ultrasonic Sensor (HC-SR04):</strong> 
          </li>
          <p> A low-cost ultrasonic sensor capable of measuring distances from 2 cm to 4 meters with an accuracy of Â±2 mm <br>
            Calculates the distance to the fill level inside a fruit fly trap.<br> The sensor uses a trigger pin to initiate measurement and an echo pin to return the result.</p>
          <li>
            <strong>Power Supply:</strong> 
          </li>
          <p>Rechargeable battery and solar panel
            working together with voltage regulation to provide sustainable,
            reliable power.</p>
          <li>
            <strong>Wiring & Enclosure:</strong> 
          </li>
          <p>Protects the system from environmental hazards and ensures reliable operation by maintaining robust electrical connections</p>
          <li><strong>LoRa module:</strong></li>
          <p>A low-power, long-range radio module <br>
            Enables long-distance, low-bandwidth communication for transmitting sensor data to a central gateway </p>
        </ul>
        <h3>Wiring connections:</h3>
        <ul>
          <li> <strong>VCC - 5V</strong></li>
          <p>The HC-SR04 VCC pin is connected to a 5V power source from the ESP32 providing the necessary power for the sensor</p>
          <li><strong>GND - ESP32 ground</strong></li>
          <p>The sensorâs ground pin is connected to the ESP32âs ground pin to complete the electrical circuit</p>
          <li><strong>Trig - GPIO5</strong></li>
          <p> The trigger pin of the HC-SR04 is connected to GPIO5 on the ESP32. The ESP32 sends a short pulse to this pin to initiate an ultrasonic measurement</p>
          <li><strong>Echo - GPIO18</strong></li>
          <p> The echo pin is connected to GPIO18 on the ESP32. This pin outputs a pulse whose duration corresponds to the time taken for the ultrasonic wave to return, which the ESP32 uses to calculate distance</p>
        </ul>
        <h3>Power management strategy:</h3>
        <p>
          Firmware leverages deep sleep cycles between sensor readings to
          maximize battery life, waking periodically to take measurements and
          transmit data.
        </p>
      </section>

      <section id="software" tabindex="-1">
        <h2>7. Software design</h2>
        <h3>ESP32 firmware flow</h3>
        <p>The firmware continuously:</p>
        <ol>
          <li>Initializes sensors and network connection.</li>
          <li>Measures ultrasonic echo time to derive distance.</li>
          <li>
            Constructs a JSON payload with sensor data and metadata (battery
            voltage, timestamp, device ID).
          </li>
          <li>
            Connects securely to MQTT broker over TLS to publish telemetry.
          </li>
          <li>Enters low-power sleep until the next measurement cycle.</li>
          <li>Handles disconnection/retries with exponential backoff.</li>
        </ol>
        <pre><code>// Simplified sensor read snippet
    long duration = pulseIn(echoPin, HIGH);
    float distance = (duration / 2.0) * 0.0343; // cm
    </code></pre>
        <h3>Backend API</h3>
        <p>Implemented with Django REST Framework:</p>
        <ul>
          <li>Secured endpoints using JWT authentication.</li>
          <li>Telemetry route validates and stores incoming JSON data.</li>
          <li>Threshold checks trigger Celery tasks to send SMS alerts.</li>
          <li>Device registration and metadata management endpoints.</li>
        </ul>
        <pre><code>CREATE TABLE devices (
        device_id VARCHAR PRIMARY KEY,
        device_identifier VARCHAR,
        status VARCHAR,
        user_id VARCHAR REFERENCES users(users_id),
        created_at TIMESTAMP,
        updated_at TIMESTAMP
        );

        CREATE TABLE data_monitoring (
        device_no VARCHAR REFERENCES devices(device_id),
        trap_fill_level INT,
        timestamp TIMESTAMP,
        updated_at TIMESTAMP,
        created_at TIMESTAMP
        );
    </code></pre>
        <h3>SMS Alert integration</h3>
        <p>SMS Leopard REST API client supports:</p>
        <ul>
          <li>Basic Auth with Base64 encoded keys.</li>
          <li>Retry with exponential backoff on failures.</li>
          <li>Logging and alert history maintenance.</li>
        </ul>
        <h3>Frontend application</h3>
        <p>Developed in React/Next.js:</p>
        <ul>
          <li>Responsive dashboard visualizing trap metrics.</li>
          <li>Role-based access control for users and admins.</li>
          <li>Real-time data update logic with polling(future).</li>
        </ul>
      </section>

      <section id="communication" tabindex="-1">
        <h2>8. Communication protocols</h2>
        <h3>MQTT Topics & Quality-of-Service</h3>
        <p>Standardized topic format:</p>
        <code>fruitguard/devices/{device_id}/telemetry</code>
        <p>QoS level 1 ensures message delivery without duplicates.</p>
        <h3>Payload JSON Schema</h3>
        <pre><code>{
        "device_id": "FG123456",
        "timestamp": "2025-10-01T12:45:00Z",
        "distance_cm": 15.5,
        }
    </code></pre>
        <h3>REST API endpoint</h3>
        <ul>
          <li>
            <code>POST /api/telemetry/</code> - accepts telemetry JSON with JWT
            Bearer token
          </li>
          <li>Returns 200 OK on success, descriptive error codes on failure</li>
        </ul>
        <h3>Security considerations</h3>
        <ul>
          <li>
            All communications secured with TLS (MQTT on port 8883, REST via
            HTTPS)
          </li>
          <li>
            Environment variables used to store secrets and rotate keys
            regularly
          </li>
          <li>Use of JWT tokens for stateless API authentication</li>
        </ul>
      </section>

      <section id="deployment" tabindex="-1">
        <h2>9. Installation & Deployment</h2>
        <h3>Hardware setup</h3>
        <ol>
          <li>Assemble ESP32 and sensors securely in enclosure.</li>
          <li>Connect regulated power supply and battery.</li>
          <li>
            Set sensor sensitivity and limits according to the specific design
            of the trap.
          </li>
        </ol>
        <h3>Firmware production</h3>
        <ol>
          <li>Set MQTT credentials and broker URL in source.</li>
          <li>Flash ESP32 using Arduino IDE.</li>
          <li>Test connectivity and telemetry transmission.</li>
        </ol>
        <h3>Backend deployment</h3>
        <ol>
          <li>Configure environment variables for DB, MQTT, SMS keys.</li>
          <li>Run Django migrations and start API with Gunicorn.</li>
          <li>Deploy backend on cloud platforms (Heroku) with HTTPS.</li>
        </ol>
        <h3>Frontend deployment</h3>
        <ol>
          <li>Build the React app using <code>npm run build</code>.</li>
          <li>
            Deploy static files on Vercel, Netlify, or CDN-enabled hosting.
          </li>
          <li>Configure frontend env variables to point to backend APIs.</li>
        </ol>
      </section>

      <section id="usage" tabindex="-1">
        <h2>10. Usage guide</h2>
        <p>
          <strong>Farmers:</strong> Monitor traps and receive SMS maintenance
          alerts to take action timely.
        </p>
        <p>
          <strong>Administrators:</strong> Manage users(agrovet and admin) and
          devices, verify system health, analyze aggregated data, and apply
          configuration changes.
        </p>
        <h3>Dashboard capabilities</h3>
        <ul>
          <li>
            Dashboard cards display key metrics: number of active agrovet users
            and active traps.
          </li>
          <li>
            Profile section allows users to view and edit their personal
            information.
          </li>
          <li>
            Real-time trap status overview with alerts and notifications for
            action.
          </li>
        </ul>
      </section>

      <section id="maintenance" tabindex="-1">
        <h2>11. Maintenance & Troubleshooting</h2>
        <table>
          <thead>
            <tr>
              <th>Issue</th>
              <th>Cause</th>
              <th>Recommended fix</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>MQTT fails to connect</td>
              <td>Incorrect credentials, network failure</td>
              <td>Check MQTT settings, restart device, verify connectivity</td>
            </tr>
            <tr>
              <td>Sensor readings always 0</td>
              <td>Hardware fault or wiring issue</td>
              <td>Inspect sensor wiring, replace sensor if defective</td>
            </tr>
            <tr>
              <td>No SMS alerts</td>
              <td>Invalid API key or message formatting error</td>
              <td>
                Validate API credentials, verify message formats and phone
                numbers
              </td>
            </tr>
            <tr>
              <td>API 401 Unauthorized</td>
              <td>Expired or missing JWT token</td>
              <td>Refresh token or reauthenticate client</td>
            </tr>
            <tr>
              <td>Dashboard data delayed</td>
              <td>Backend or frontend sync issues</td>
              <td>
                Restart backend services, refresh frontend, check network logs
              </td>
            </tr>
          </tbody>
        </table>
        <h3>Recommended maintenance</h3>
        <ul>
          <li>
            Checking and adjusting the sensor regularly to make sure it gives
            correct and accurate measurements."
          </li>
          <li>Periodic firmware updates.</li>
          <li>Monitor logs and alert history for anomalies.</li>
          <li>Backup device and user data periodically.</li>
        </ul>
      </section>

      <section id="security" tabindex="-1">
        <h2>12. Security considerations</h2>
        <ul>
          <li>
            <strong>Authentication: </strong>JWT-based token authentication for
            APIs and devices.
          </li>
          <li>
            <strong>Encryption: </strong>TLS 1.2+ for MQTT and HTTPS for all web
            requests.
          </li>
          <li>
            <strong>Access Control: </strong>Role-based permissions for farmers,
            admins, and devices.
          </li>
          <li>
            <strong>Input Validation: </strong>Strict server-side input
            sanitization to prevent injection attacks.
          </li>
          <li>
            <strong>Audit Logging: </strong>All access and error logs recorded
            for security audit.
          </li>
        </ul>
      </section>

      <section id="testing" tabindex="-1">
        <h2>13. Testing and monitoring</h2>
        <ul>
          <li>
            Unit tests covering backend API, firmware sensor logic, and frontend
            components.
          </li>
          <li>
            Integration tests with simulated MQTT data streams and API
            workflows.
          </li>
          <li>
            Monitoring tools for system health, Sentry for error tracking.
          </li>
          <li>
            Success metrics tracking include uptime, data completeness, and
            alert delivery.
          </li>
          <li>Postman collections automate API contract testing.</li>
        </ul>
      </section>

      <section id="future" tabindex="-1">
        <h2>14. Future enhancements</h2>
        <ul>
          <li>
            <strong>Predictive analytics:</strong> AI-driven trap fill trend
            prediction.
          </li>
          <li>
            <strong>LoRaWAN:</strong> IoT network expansion for wide-area
            deployments.
          </li>
          <li>
            <strong>Additional sensors:</strong> Environmental sensors for
            humidity, temperature.
          </li>
        </ul>
      </section>

      <section id="api" tabindex="-1">
        <h2>15. API</h2>

        <h3>Data Monitoring API</h3>
        <p>
          <a href="#" target="_blank"
            >https://fruitguard-3b97d3adfdf5.herokuapp.com/api/data_monitoring/</a
          >
        </p>
        <p>Telemetry data ingestion and querying endpoint.</p>
        <pre>
        <code>{
        "trap_fill_level": 0,
        "updated_at": "2025-09-12T19:18:29.240879Z",
        "created_at": "2025-09-12T19:18:29.240907Z",
        "device": 5
        }
        </code>
    </pre>

        <h3>Device API</h3>
        <p>
          <a href="#" target="_blank"
            >https://fruitguard-3b97d3adfdf5.herokuapp.com/api/device/</a
          >
        </p>
        <p>CRUD devices registered in system.</p>
        <pre>
        <code>{
        "device_id": 5,
        "device_identifier": "ESP32-000000000001",
        "status": "Active",
        "created_at": "2025-09-11",
        "user_id": 1
        }
        </code>
    </pre>

        <h3>Users API</h3>
        <p>
          <a href="#" target="_blank"
            >https://fruitguard-3b97d3adfdf5.herokuapp.com/api/users/</a
          >
        </p>
        <p>User account management.</p>
        <pre><code>{
        "id": 1,
        "first_name": "Mariana",
        "last_name": "Nyambura",
        "phone_number": "0716088246",
        "email": "esthenyambua@gmail.com",
        "profile_image": null,
        "location": null,
        "number_of_traps": null,
        "user_type": "agrovet",
        "created_at": "2025-09-11T05:07:46.944957Z"
        }
    </code></pre>
    <h3>API documentation links</h3>
        <p>
          Access comprehensive and interactive API documentation to facilitate
          integration and development:
        </p>
        <ul>
          <li>
            <a
              href="https://fruitguard-3b97d3adfdf5.herokuapp.com/api/schema/swagger-ui/"
              target="_blank"
              rel="noopener"
              >Swagger UI</a
            >
            - Interactive API explorer.
          </li>
          <li>
            <a
              href="https://fruitguard-3b97d3adfdf5.herokuapp.com/api/schema/redoc/"
              target="_blank"
              rel="noopener"
              >ReDoc</a
            >
            - Clean, responsive API docs.
          </li>
        </ul>
      </section>
      <section id="best-practices" tabindex="-1">
        <h2>16. Best practices and standards</h2>
        <h3>Coding conventions</h3>
        <ul>
          <li>
            <strong>Frontend:</strong> Use React functional components, apply
            TypeScript for type safety, and Tailwind CSS for styling.
          </li>
          <li>
            <strong>Backend:</strong> Follow Django REST Framework standards
            with snake_case for variables and PascalCase for models.
          </li>
        </ul>
        <h3>Testing tools</h3>
        <ul>
          <li>
            Frontend: Jest and React Testing Library for unit and integration
            tests.
          </li>
          <li>
            Backend: Django test framework with
            <code>python manage.py test</code>.
          </li>
        </ul>
        <h3>Linting and code quality</h3>
        <ul>
          <li>Use ESLint and Prettier for frontend code consistency.</li>
          <li>Use flake8 and black for Python backend code formatting.</li>
        </ul>
        <h3>CI/CD process</h3>
        <ul>
          <li>
            Automatic testing, linting, and builds triggered on every Pull
            Request via GitHub Actions.
          </li>
          <li>Merge only after passing tests and code review approvals.</li>
        </ul>
      </section>

      <section id="deployment-ci-cd" tabindex="-1">
        <h2>17. Deployment and CI/CD</h2>
        <h3>Frontend Deployment</h3>
        <ul>
          <li><strong>Platform:</strong> Vercel</li>
          <li><strong>Branch:</strong> Auto deployment from main</li>
          <li><strong>Environment variables:</strong> Managed securely through .env in Vercel dashboard.</li>
          <li><strong>Build & Preview:</strong> Each push triggers preview builds for PRs and deploys on merge to main.</li>
        </ul>
        <h3>Backend Deployment</h3>
        <ul>
          <li><strong>Platform:</strong> Heroku</li>
          <li><strong>Environment variables:</strong> Configured in Heroku dashboard</li>
        </ul>


        <h3>Automated pipelines</h3>
       <ul>
        <li><strong>Tool: </strong> GitHub Actions.</li>
        <li><strong>Pre-Deployment:</strong> All codebases run tests, build and lint checks before deploying</li>
        <li><strong>Automation:</strong> Automatic deployment on merge to main</li>
        <li><strong>Status: </strong> Build and test status visible in PRs and repository dashboard</li>
       </ul>
      </section>

   
    </main>

    <footer class="footer">
      &copy; 2025 FruitGuard. All rights reserved.
      <a href="mailto:support@fruitguard.com">Contact Support</a> |
      <a
        href="https://fruitguard.com/privacy-policy"
        target="_blank"
        rel="no referrer"
        >Privacy Policy</a
      >
    </footer>
    <div
      id="imageModal"
      class="modal"
      role="dialog"
      aria-label="Enlarged image modal"
      tabindex="-1"
    >
      <span class="modal-close" role="button" aria-label="Close modal"
        >&times;</span
      >
      <img
        class="modal-content"
        id="modalImage"
        alt="Enlarged view of selected image"
      />
    </div>
  </body>
</html>
